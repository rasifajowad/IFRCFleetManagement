// Prisma schema for city-fleet-scheduler-next

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  staff
  officer
  driver
}

model User {
  id                String    @id
  name              String
  role              Role
  email             String?   @unique
  passwordHash      String?
  avatarUrl         String?
  createdAt         DateTime  @default(now())
  phone             String?
  department        String?
  title             String?
  location          String?
  active            Boolean   @default(true)
  driverLicenseNo   String?
  driverLicenseExpiry DateTime?
  requests          Request[]
  driverBookings    Booking[] @relation("DriverBookings")
  requesterBookings Booking[] @relation("RequesterBookings")
  assignedVehicles  Vehicle[] @relation("AssignedDriver")
  auditLogs         AuditLog[]
}

model AuditLog {
  id         String   @id @default(cuid())
  actor      User     @relation(fields: [actorId], references: [id])
  actorId    String
  action     String
  entityType String
  entityId   String
  before     Json?
  after      Json?
  createdAt  DateTime @default(now())
}

model Vehicle {
  id               String    @id
  name             String
  plate            String
  assignedDriver   User?     @relation("AssignedDriver", fields: [assignedDriverId], references: [id])
  assignedDriverId String?
  registrationNumber String?
  ifrcCode          String?
  organizationName  String?
  modelName         String?
  engineNumber      String?
  engineCapacity    String?
  chassisNumber     String?
  yearManufacture   Int?
  deployedArea      String?
  contractExpiry    DateTime?
  registrationExpiry DateTime?
  primaryImageUrl   String?
  bookings         Booking[]
  images           VehicleImage[]
}

model VehicleImage {
  id        String   @id @default(cuid())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId String
  url       String
  createdAt DateTime @default(now())
}

model Document {
  id        String   @id @default(cuid())
  name      String
  detail    String?
  fileUrl   String
  fileName  String
  mimeType  String?
  fileData  Bytes?
  createdAt DateTime @default(now())
}

model BugReport {
  id          String   @id @default(cuid())
  name        String
  designation String
  message     String
  createdAt   DateTime @default(now())
}

model Request {
  id                 String    @id
  requester          User      @relation(fields: [requesterId], references: [id])
  requesterId        String
  purpose            String
  preferredVehicleId String? // deprecated: staff no longer selects vehicle
  startLocation      String   @default("")
  destination        String   @default("")
  startTime          DateTime
  endTime            DateTime
  notes              String
  status             String // Pending | Approved
  createdAt          DateTime  @default(now())
  bookings           Booking[]
}

model Booking {
  id            String    @id
  request       Request   @relation(fields: [requestId], references: [id])
  requestId     String
  vehicle       Vehicle   @relation(fields: [vehicleId], references: [id])
  vehicleId     String
  driver        User      @relation("DriverBookings", fields: [driverId], references: [id])
  driverId      String
  requester     User      @relation("RequesterBookings", fields: [requesterId], references: [id])
  requesterId   String
  purpose       String
  startTime     DateTime
  endTime       DateTime
  status        String // Booked | InUse | Completed
  notes         String
  override      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  actualStart   DateTime?
  actualEnd     DateTime?
  startLocation String?
  endLocation   String?
  odometerStart Int?
  odometerEnd   Int?
}


